name: Build Buildroot

on:
  push:
    branches:
      - main
      
  workflow_dispatch:

env:
  REPO_URL: https://github.com/buildroot/buildroot
  REPO_BRANCH: 2021.08.x
  CONFIG_FILE: .config
  TZ: Europe/Vienna

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@main
        
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq upgrade
          sudo apt install wget git bc bison linux-headers-$(uname -r)
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
      
      - name: Clone buildroot source code
        working-directory: /workdir
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH buildroot
          ln -sf /workdir/buildroot $GITHUB_WORKSPACE/buildroot
      
      - name: Load Unipi Neuron RPi 3B configuration
        run: |
          cd $GITHUB_WORKSPACE/buildroot
          make BR2_EXTERNAL=$GITHUB_WORKSPACE/unipi-buildroot unipi_neuron_rpi3b_defconfig
